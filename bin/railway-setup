#!/usr/bin/env ruby

# Railway ë°°í¬ ì‹œ ì‹¤í–‰ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸
require_relative "../config/environment"

puts "ğŸš€ Railway ë°°í¬ - ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ì‹œì‘..."

begin
  # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
  ActiveRecord::Base.connection.execute("SELECT 1")
  puts "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ"
rescue => e
  puts "âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨: #{e.message}"
  exit 1
end

begin
  # ë°ì´í„°ë² ì´ìŠ¤ ì¡´ì¬ í™•ì¸ ë° ìƒì„±
  unless ActiveRecord::Base.connection.data_source_exists?('users')
    puts "ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤. ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤..."
    system("rails db:create") or puts "ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
  end

  # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
  puts "ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘..."
  system("rails db:migrate") or raise "ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨"
  puts "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ"

  # ê¸°ë³¸ ë°ì´í„° í™•ì¸ ë° ì‹œë“œ
  if User.count == 0
    puts "ğŸ‘¤ ê¸°ë³¸ ì‚¬ìš©ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì‹œë“œ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤..."
    system("rails db:seed") or raise "ì‹œë“œ ë°ì´í„° ìƒì„± ì‹¤íŒ¨"
    puts "âœ… ì‹œë“œ ë°ì´í„° ìƒì„± ì™„ë£Œ"
  else
    puts "ğŸ‘¤ ê¸°ë³¸ ì‚¬ìš©ì ë°ì´í„°ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
  end

  # ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸
  puts "\nğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ:"
  puts "- ì‚¬ìš©ì ìˆ˜: #{User.count}"
  puts "- ê³µì§€ì‚¬í•­ ìˆ˜: #{Announcement.count}" if defined?(Announcement)
  puts "- ëŒ€í™” íˆìŠ¤í† ë¦¬: #{ConversationHistory.count}" if defined?(ConversationHistory)

  puts "\nğŸ‰ Railway ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ì™„ë£Œ!"

rescue => e
  puts "âŒ ì„¤ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ: #{e.message}"
  puts e.backtrace.first(5)
  exit 1
end